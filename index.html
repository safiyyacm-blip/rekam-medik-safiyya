<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Rekam Medik TCM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        @media print {
            body > *:not(#form-view) {
                display: none;
            }
            #form-view {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: auto;
                background-color: #fff;
                display: block !important;
                overflow: visible !important;
            }
            #form-view > div {
                box-shadow: none !important;
                max-width: none !important;
            }
            #form-view button {
                display: none;
            }
            #form-view input, #form-view textarea {
                border: none;
                background-color: #fff;
                box-shadow: none;
                padding-left: 0;
                padding-right: 0;
            }
        }

        .tooltip-container {
            position: relative;
            display: inline-block;
        }

        .tooltip-icon {
            cursor: pointer;
            font-weight: bold;
            color: #6b7280;
        }

        .tooltip-content {
            visibility: hidden;
            background-color: #374151;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px 12px;
            position: absolute;
            z-index: 10;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            width: 300px;
            text-align: left;
            font-weight: normal;
        }

        .tooltip-content::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #374151 transparent transparent transparent;
        }

        .tooltip-container:hover .tooltip-content {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body class="p-4 sm:p-8 bg-gray-100 min-h-screen flex items-center justify-center">

    <div id="loading" class="fixed inset-0 bg-gray-200/50 flex items-center justify-center z-50 hidden">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-blue-500"></div>
    </div>

    <!-- Message Box -->
    <div id="message-box" class="fixed top-4 right-4 z-[100] transition-transform duration-300 transform translate-x-full">
        <div class="bg-gray-800 text-white px-4 py-3 rounded-lg shadow-lg flex items-center space-x-2">
            <svg id="message-icon" class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
            </svg>
            <p id="message-text" class="text-sm font-medium"></p>
        </div>
    </div>
    
    <div class="bg-white p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-4xl">
        <div class="flex flex-col sm:flex-row justify-between items-center mb-6">
            <div class="text-center sm:text-left">
                <h1 class="text-3xl sm:text-4xl font-bold text-gray-800">Rekam Medik Akupunktur & Herbal</h1>
                <p class="text-xl text-gray-600 mt-1">Safiyya-TCM Malang</p>
            </div>
            <div class="text-sm text-gray-500 mt-2 sm:mt-0">
                <span class="font-semibold">ID Pengguna:</span> <span id="user-id">Memuat...</span>
            </div>
        </div>
        
        <!-- Tampilan Login (Layer 0) -->
        <div id="login-view" class="space-y-6 flex flex-col items-center justify-center min-h-[400px]">
            <h2 class="text-2xl font-semibold text-gray-700">Login</h2>
            <form id="login-form" class="w-full max-w-sm space-y-4">
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700">Nama Pengguna</label>
                    <input type="text" id="username" name="username" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700">Kata Sandi</label>
                    <input type="password" id="password" name="password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <button type="submit" class="w-full px-6 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Masuk
                </button>
                <div id="login-error-message" class="text-sm text-red-500 text-center hidden"></div>
            </form>
        </div>


        <!-- Tampilan Daftar Pasien (Layer 1) -->
        <div id="patient-list-view" class="space-y-6 hidden">
            <div class="flex justify-between items-center">
                <button id="add-new-patient-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    Tambah Pasien Baru
                </button>
                <button id="logout-btn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-300">
                    Keluar
                </button>
            </div>
            
            <h2 class="text-xl sm:text-2xl font-semibold text-gray-700">Daftar Pasien</h2>
            <div class="overflow-x-auto shadow-sm rounded-lg">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Pasien</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID Pasien</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="patient-list" class="bg-white divide-y divide-gray-200">
                        <!-- Pasien akan dimuat di sini -->
                    </tbody>
                </table>
                <div id="no-patients" class="text-center text-gray-500 p-4 hidden">Belum ada pasien yang ditambahkan.</div>
            </div>
        </div>

        <!-- Tampilan Formulir (Layer 2) -->
        <div id="form-view" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 id="form-title" class="text-xl sm:text-2xl font-semibold text-gray-700">Tambah Pasien Baru</h2>
                <button id="back-btn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-300">
                    Kembali ke Daftar
                </button>
            </div>
            
            <form id="patient-form" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700">Nama Pasien</label>
                        <input type="text" id="name" name="name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="patientId" class="block text-sm font-medium text-gray-700">ID Pasien Unik</label>
                        <input type="text" id="patientId" name="patientId" required readonly class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-100 sm:text-sm">
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="tanggalLahir" class="block text-sm font-medium text-gray-700">Tanggal Lahir</label>
                        <input type="date" id="tanggalLahir" name="tanggalLahir" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="umur" class="block text-sm font-medium text-gray-700">Umur</label>
                        <input type="text" id="umur" name="umur" readonly class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-100 sm:text-sm">
                    </div>
                </div>
                <div>
                    <label for="jenisKelamin" class="block text-sm font-medium text-gray-700">Jenis Kelamin</label>
                    <select id="jenisKelamin" name="jenisKelamin" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        <option value="">Pilih</option>
                        <option value="Laki-laki">Laki-laki</option>
                        <option value="Perempuan">Perempuan</option>
                    </select>
                </div>
                <div>
                    <label for="agama" class="block text-sm font-medium text-gray-700">Agama</label>
                    <select id="agama" name="agama" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        <option value="">Pilih</option>
                        <option value="Islam">Islam</option>
                        <option value="Katolik">Katolik</option>
                        <option value="Protestan">Protestan</option>
                        <option value="Hindu">Hindu</option>
                        <option value="Buddha">Buddha</option>
                        <option value="Konghucu">Konghucu</option>
                        <option value="Lain-lain">Lain-lain</option>
                    </select>
                    <input type="text" id="agamaLainnyaInput" name="agamaLainnyaInput" placeholder="Masukkan agama lainnya..." class="mt-2 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm hidden">
                </div>
                <div>
                    <label for="pekerjaan" class="block text-sm font-medium text-gray-700">Pekerjaan</label>
                    <select id="pekerjaan" name="pekerjaan" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        <option value="">Pilih</option>
                        <option value="Pelajar/Mahasiswa">Pelajar/Mahasiswa</option>
                        <option value="PNS">PNS</option>
                        <option value="Pegawai Swasta">Pegawai Swasta</option>
                        <option value="Wiraswasta">Wiraswasta</option>
                        <option value="Petani">Petani</option>
                        <option value="Ibu Rumah Tangga">Ibu Rumah Tangga</option>
                        <option value="Lain-lain">Lain-lain</option>
                    </select>
                    <input type="text" id="pekerjaanLainnyaInput" name="pekerjaanLainnyaInput" placeholder="Masukkan pekerjaan lainnya..." class="mt-2 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm hidden">
                </div>
                <div>
                    <label for="tanggal" class="block text-sm font-medium text-gray-700">Tanggal Kunjungan</label>
                    <input type="date" id="tanggal" name="tanggal" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div>
                    <label for="alamat" class="block text-sm font-medium text-gray-700">Alamat</label>
                    <textarea id="alamat" name="alamat" rows="2" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="nik" class="block text-sm font-medium text-gray-700">NIK</label>
                        <input type="text" id="nik" name="nik" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="noHp" class="block text-sm font-medium text-gray-700">No. HP</label>
                        <input type="text" id="noHp" name="noHp" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Kategori Kunjungan</label>
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3">
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="kunjunganKategori" value="Nyeri" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Nyeri</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="kunjunganKategori" value="Internal" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Internal</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="kunjunganKategori" value="Eksternal" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Eksternal</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="kunjunganKategori" value="Promil" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Promil</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="kunjunganKategori" value="Ginekologi" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Ginekologi</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="kunjunganKategori" value="Rehabilitasi Stroke" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Rehabilitasi Stroke</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="kunjunganKategori" value="Psiko Somatik" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Psiko Somatik</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="kunjunganKategori" value="Pemeliharaan Kesehatan" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Pemeliharaan Kesehatan</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="kunjunganKategori" value="Promil Online" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Promil Online</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="kunjunganKategori" value="Pendampingan IVF" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Pendampingan IVF</span>
                        </label>
                    </div>
                </div>
                <div>
                    <label for="keluhanUtama" class="block text-sm font-medium text-gray-700">Keluhan Utama</label>
                    <textarea id="keluhanUtama" name="keluhanUtama" rows="3" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
                </div>
                <div>
                    <label for="keluhanTambahan" class="block text-sm font-medium text-gray-700">Keluhan Tambahan</label>
                    <textarea id="keluhanTambahan" name="keluhanTambahan" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
                </div>
                <div>
                    <label for="anamnesa" class="block text-sm font-medium text-gray-700">Anamnesa (Keluhan & Riwayat Penyakit)</label>
                    <textarea id="anamnesa" name="anamnesa" rows="3" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
                </div>
                <div>
                    <label for="pemeriksaanFisik" class="block text-sm font-medium text-gray-700">Pemeriksaan Fisik</label>
                    <textarea id="pemeriksaanFisik" name="pemeriksaanFisik" rows="3" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
                </div>
                <div class="space-y-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Pemeriksaan Nadi (TCM)</label>
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3">
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="pemeriksaanNadi" value="Nadi Fu/Mengambang (浮脈)" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Nadi Fu/Mengambang (浮脈)</span>
                            <span class="tooltip-container">
                                <span class="tooltip-icon">i</span>
                                <span class="tooltip-content">"Sewaktu diangkat terasa jelas, sewaktu ditekan tidak terlalu terasa." Nadi ini menjelaskan penyakit ada di Biao/permukaan, juga menjelaskan sindrom Xu/defisiensi. Nadi ini juga ditemui pada pasien oedema (cairan didalam kulit).</span>
                            </span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="pemeriksaanNadi" value="Nadi Chen/Dalam (沉脈)" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Nadi Chen/Dalam (沉脈)</span>
                            <span class="tooltip-container">
                                <span class="tooltip-icon">i</span>
                                <span class="tooltip-content">"Sewaktu diangkat tidak terasa, sewaktu ditekan bertenaga." Nadi ini menjelaskan penyakit ada di Li/dalam, juga bisa ada pada orang normal yang tidak ada penyakit apapun.</span>
                            </span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="pemeriksaanNadi" value="Nadi Chi/Terlambat (迟脈)" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Nadi Chi/Terlambat (迟脈)</span>
                            <span class="tooltip-container">
                                <span class="tooltip-icon">i</span>
                                <span class="tooltip-content">"Satu hitungan, 3x datang." Nadi ini bisa terjadi pada gejala Han/dingin, dan Re/panas, juga bisa ada pada olahragawan/atlet.</span>
                            </span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="pemeriksaanNadi" value="Nadi Shuo/Cepat (数脈)" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Nadi Shuo/Cepat (数脈)</span>
                            <span class="tooltip-container">
                                <span class="tooltip-icon">i</span>
                                <span class="tooltip-content">"Satu hitungan, 6x datang." Nadi ini menjelaskan gejala Re/panas, Yin Xu/Defisiensi Yin, Qi Xu/Defisiensi Qi, Xue Xu/Defisiensi Xue, gejala Han/dingin juga ditemui pada nadi Shuo. Nadi ini juga sering ada pada bayi berusia sebulan, orang yang melakukan aktivitas berat, minum alcohol, baru saja makan, maupun rangsangan emosi berlebihan.</span>
                            </span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="pemeriksaanNadi" value="Nadi Hong/Besar (洪脈)" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Nadi Hong/Besar (洪脈)</span>
                            <span class="tooltip-container">
                                <span class="tooltip-icon">i</span>
                                <span class="tooltip-content">"Sewaktu ditekan mengambang dan besar, dibawah jari terasa penuh." Nadi ini menjelaskan panas didalam tubuh/organ tubuh, ada pada gejala demam tinggi, infeksi, etc. Bisa juga terjadi pada Qi Xu/Defisiensi Qi, kehilangan darah, terlalu lelah, mencret berkepanjangan, etc.</span>
                            </span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="pemeriksaanNadi" value="Nadi Wei/Kecil (微脈)" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Nadi Wei/Kecil (微脈)</span>
                            <span class="tooltip-container">
                                <span class="tooltip-icon">i</span>
                                <span class="tooltip-content">"Amat kecil, lunak, hampir tidak terasa, seperti ada dan tidak." Nadi ini menjelaskan defisiensi Qi dan Xue. Pada sakit berkepanjangan/kronis, nadi ini menjelaskan prognosis jelek. Pada sakit akut, nadi ini menjelaskan prognosis baik.</span>
                            </span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="pemeriksaanNadi" value="Nadi Xi/Halus (细脈)" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Nadi Xi/Halus (细脈)</span>
                            <span class="tooltip-container">
                                <span class="tooltip-icon">i</span>
                                <span class="tooltip-content">"Halus seperti benang, tapi terasa di jari." Nadi ini menjelaskan defisiensi Qi dan Xue, faktor patogen lembab.</span>
                            </span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="pemeriksaanNadi" value="Nadi San/Lepas (散脈)" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Nadi San/Lepas (散脈)</span>
                            <span class="tooltip-container">
                                <span class="tooltip-icon">i</span>
                                <span class="tooltip-content">"Mengambang lepas dan tidak ada dasarnya, tidak beraturan." Nadi ini menjelaskan Yuan Qi lepas dan hilang.</span>
                            </span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="pemeriksaanNadi" value="Nadi Xu/Lemah (虚脈)" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Nadi Xu/Lemah (虚脈)</span>
                            <span class="tooltip-container">
                                <span class="tooltip-icon">i</span>
                                <span class="tooltip-content">"3 jari diangkat tidak bertenaga, ditekan kosong." Nadi ini menjelaskan gejala Xu/defisiensi.</span>
                            </span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="pemeriksaanNadi" value="Nadi Shi/Penuh (实脈)" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Nadi Shi/Penuh (实脈)</span>
                            <span class="tooltip-container">
                                <span class="tooltip-icon">i</span>
                                <span class="tooltip-content">"3 jari diangkat dan ditekan terasa bertenaga." Nadi ini menjelaskan gejala Shi/ekses, gejala panas, faktor patogen yang berlebihan. Nadi ini juga dijumpai pada orang normal.</span>
                            </span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="pemeriksaanNadi" value="Nadi Hua/Licin (滑脈)" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Nadi Hua/Licin (滑脈)</span>
                            <span class="tooltip-container">
                                <span class="tooltip-icon">i</span>
                                <span class="tooltip-content">"Lancar tanpa putus, seperti mutiara diatas nampan, terasa dijari licin dan bundar." Nadi ini menjelaskan gejala Tan/dahak, gejala Yin/cairan tubuh, makanan yang tidak tercerna, panas ekses ditubuh, darah stasis. Pada orang normal, nadi ini juga sering dijumpai. Wanita hamil, sering dijumpai nadi Hua/licin dan Shuo/cepat.</span>
                            </span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="pemeriksaanNadi" value="Nadi Se/Seret (涩脈)" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Nadi Se/Seret (涩脈)</span>
                            <span class="tooltip-container">
                                <span class="tooltip-icon">i</span>
                                <span class="tooltip-content">"Lambat, halus dan pendek, seret, tidak lancar." Nadi ini bisa berarti Xu/defisiensi, bisa berarti Shi/ekses. Bila Shi/ekses, maka pasti terasa penuh bertenaga. Misalnya pada gejala Tan/dahak, makanan tidak tercerna, Qi macet dan darah stasis.</span>
                            </span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="pemeriksaanNadi" value="Nadi Chang/Panjang (长脈)" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Nadi Chang/Panjang (长脈)</span>
                            <span class="tooltip-container">
                                <span class="tooltip-icon">i</span>
                                <span class="tooltip-content">"Kepala dan ekor terasa panjang, melewati 1 ruas jari." Nadi ini biasanya ada pada ekses Yang Liver. Bila ditemui nadi Chang/Panjang dan nadi Huan/Lambat, ini termasuk nadi normal.</span>
                            </span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="pemeriksaanNadi" value="Nadi Duan/Pendek (短脈)" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Nadi Duan/Pendek (短脈)</span>
                            <span class="tooltip-container">
                                <span class="tooltip-icon">i</span>
                                <span class="tooltip-content">"Kepala dan ekor terasa pendek, tidak sampai 1 ruas jari." Nadi ini biasanya ada pada gejala Qi, baik Defisiensi maupun ekses.</span>
                            </span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="pemeriksaanNadi" value="Nadi Xian/Senar (弦脈)" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Nadi Xian/Senar (弦脈)</span>
                            <span class="tooltip-container">
                                <span class="tooltip-icon">i</span>
                                <span class="tooltip-content">"Tegang dan lurus seperti memegang senar kecapi." Nadi ini menjelaskan gejala Liver dan empedu, Tan/dahak, cairan tubuh yang berhenti, sakit dibagian tubuh, malaria, juga gejala Xu/defisiensi.</span>
                            </span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="pemeriksaanNadi" value="Nadi Kou/Kosong (芤脈)" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Nadi Kou/Kosong (芤脈)</span>
                            <span class="tooltip-container">
                                <span class="tooltip-icon">i</span>
                                <span class="tooltip-content">"Mengambang dan besar tapi terasa kosong, seperti menekan batang daun bawang." Nadi ini menjelaskan gejala kehilangan darah, Yin tubuh luka atau defisiensi Yin.</span>
                            </span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="pemeriksaanNadi" value="Nadi Jin/Rapat (紧脈)" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Nadi Jin/Rapat (紧脈)</span>
                            <span class="tooltip-container">
                                <span class="tooltip-icon">i</span>
                                <span class="tooltip-content">"Nadi datang beriringan, saling menyambung tanpa putus." Nadi ini menjelaskan gejala Han/dingin, sakit di bagian tubuh, makanan yang tidak tercerna.</span>
                            </span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="pemeriksaanNadi" value="Nadi Huan/Lambat (缓脈)" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Nadi Huan/Lambat (缓脈)</span>
                            <span class="tooltip-container">
                                <span class="tooltip-icon">i</span>
                                <span class="tooltip-content">"Satu hitungan 4x datang, datang dan pergi terasa pelan." Nadi ini menjelaskan gejala Lembab, pencernaan lemah, angin dan gejala panas di dalam tubuh.</span>
                            </span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="pemeriksaanNadi" value="Nadi Ge/革脉" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Nadi Ge/革脈</span>
                            <span class="tooltip-container">
                                <span class="tooltip-icon">i</span>
                                <span class="tooltip-content">"Mengambang terasa di jari, di dalam kosong, diluar keras, seperti menekan tambur." Nadi ini menjelaskan kehilangan darah, kehilangan Jing Ginjal, pendarahan, kebanyakan karena defisiensi Qi yang mengakibatkan defisiensi Ying Xue.</span>
                            </span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="pemeriksaanNadi" value="Nadi Lao/Keras (牢脈)" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Nadi Lao/Keras (牢脈)</span>
                            <span class="tooltip-container">
                                <span class="tooltip-icon">i</span>
                                <span class="tooltip-content">"Ditekan dalam terasa penuh, panjang dan seperti senar, tidak mudah digerakkan." Nadi ini menjelaskan Yin Han yang membeku didalam, atherosclerosis. Mis: Radang ginjal kronis.</span>
                            </span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="pemeriksaanNadi" value="Nadi Ruo/Rapuh (弱脈)" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Nadi Ruo/Rapuh (弱脈)</span>
                            <span class="tooltip-container">
                                <span class="tooltip-icon">i</span>
                                <span class="tooltip-content">"Terasa sangat lunak, tipis dan dalam." Nadi ini menjelaskan Defisiensi Qi dan Xue, Yuan Qi luka. Kalau dijumpai pada orang tua, sakit berkepanjangan, tms normal.</span>
                            </span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="pemeriksaanNadi" value="Nadi Ru/濡脈" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Nadi Ru/濡脈</span>
                            <span class="tooltip-container">
                                <span class="tooltip-icon">i</span>
                                <span class="tooltip-content">"Mengambang dan terasa halus, lunak." Nadi ini menjelaskan gejala defisiensi, lembab di dalam tubuh.</span>
                            </span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="pemeriksaanNadi" value="Nadi Fu/伏脈" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Nadi Fu/伏脈</span>
                            <span class="tooltip-container">
                                <span class="tooltip-icon">i</span>
                                <span class="tooltip-content">"Ditekan kuat, mencari dengan jarii baru terasa, kadang hilang tidak terasa." Nadi ini menjelaskan Xie Qi (faktor patogen luar) yang menutup, sakit hebat didalam tubuh, defisiensi Yang didalam tubuh.</span>
                            </span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="pemeriksaanNadi" value="Nadi Dong/Bergerak (动脉)" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Nadi Dong/Bergerak (动脉)</span>
                            <span class="tooltip-container">
                                <span class="tooltip-icon">i</span>
                                <span class="tooltip-content">"Bentuknya seperti kacang, mudah digerakkan, terasa licin, cepat, bertenaga." Nadi ini menjelaskan gejala sakit, kaget. Sering juga dijumpai dalam kehamilan 1-2 bulan.</span>
                            </span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="pemeriksaanNadi" value="Nadi Cu/促脈" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Nadi Cu/促脈</span>
                            <span class="tooltip-container">
                                <span class="tooltip-icon">i</span>
                                <span class="tooltip-content">"Datang cepat, kadang terhenti, polanya tidak beraturan." Nadi ini menjelaskan ekses Yang dan panas tinggi, Qi Xue Tan Yin yang macet. Nadi ini juga menjelaskan defisiensi Yang Utama dalam tubuh.</span>
                            </span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="pemeriksaanNadi" value="Nadi Jie/结脈" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Nadi Jie/结脈</span>
                            <span class="tooltip-container">
                                <span class="tooltip-icon">i</span>
                                <span class="tooltip-content">"Datang pelan, kadang terhenti, polanya tidak beraturan." Nadi ini menjelaskan ekses Yin, Qi macet, darah stasis, Dahak dingin, makanan beku, makanan tidak tercerna, faktor patogen Han dalam Jing Luo. Nadi ini juga menjelaskan defisiensi Qi Utama dalam tubuh.</span>
                            </span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="pemeriksaanNadi" value="Nadi Dai/代脈" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Nadi Dai/代脈</span>
                            <span class="tooltip-container">
                                <span class="tooltip-icon">i</span>
                                <span class="tooltip-content">"Nadi datang kadang terhenti, polanya teratur, setelah berapa lama terulang lagi." Nadi ini menjelaskan defisiensi Qi, faktor patogen luar angin, penyakit tipes, emosi berlebihan, darah beku karena terjatuh.</span>
                            </span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="pemeriksaanNadi" value="Nadi Ji/疾脈" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Nadi Ji/疾脈</span>
                            <span class="tooltip-container">
                                <span class="tooltip-icon">i</span>
                                <span class="tooltip-content">"Nadi datang cepat terburu-buru, satu hitungan 7-8x datang." Nadi ini menjelaskan Yin dan Yang utama dalam tubuh akan hilang. Sering dijumpai pada penyakit tipes, dan panas tinggi.</span>
                            </span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" id="tcmNadiLainnya" name="pemeriksaanNadi" value="Lain-lain" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Lain-lain</span>
                        </label>
                    </div>
                    <input type="text" id="tcmNadiLainnyaInput" name="tcmNadiLainnyaInput" placeholder="Masukkan jenis nadi lainnya..." class="mt-2 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm hidden">
                </div>
                <div class="space-y-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Pemeriksaan Lidah (TCM)</label>
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3">
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="pemeriksaanLidah" value="Pucat" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Pucat</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="pemeriksaanLidah" value="Merah" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Merah</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="pemeriksaanLidah" value="Ungu" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Ungu</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="pemeriksaanLidah" value="Tebal" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Tebal</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="pemeriksaanLidah" value="Tipis" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Tipis</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="pemeriksaanLidah" value="Retak" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Retak</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="pemeriksaanLidah" value="Bengkak" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Bengkak</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="pemeriksaanLidah" value="Bintik" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Bintik</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="pemeriksaanLidah" value="Lain-lain" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Lain-lain</span>
                        </label>
                    </div>
                    <input type="text" id="tcmLidahLainnyaInput" name="tcmLidahLainnyaInput" placeholder="Masukkan kondisi lidah lainnya..." class="mt-2 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm hidden">
                </div>
                <div class="space-y-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Selaput Lidah</label>
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3">
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="pemeriksaanSelaputLidah" value="Putih" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Putih</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="pemeriksaanSelaputLidah" value="Kuning" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Kuning</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="pemeriksaanSelaputLidah" value="Abu-abu" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Abu-abu</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="pemeriksaanSelaputLidah" value="Hitam" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Hitam</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="pemeriksaanSelaputLidah" value="Tebal" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Tebal</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="pemeriksaanSelaputLidah" value="Tipis" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Tipis</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="pemeriksaanSelaputLidah" value="Kering" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Kering</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="pemeriksaanSelaputLidah" value="Basah" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Basah</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="pemeriksaanSelaputLidah" value="Lain-lain" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Lain-lain</span>
                        </label>
                    </div>
                    <input type="text" id="tcmSelaputLidahLainnyaInput" name="tcmSelaputLidahLainnyaInput" placeholder="Masukkan selaput lidah lainnya..." class="mt-2 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm hidden">
                </div>
                <div>
                    <label for="nyeri" class="block text-sm font-medium text-gray-700">Nyeri</label>
                    <textarea id="nyeri" name="nyeri" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
                </div>
                <div class="space-y-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Meridian</label>
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3">
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="meridianTcm" value="Taiyin Tangan LU" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Taiyin Tangan LU</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="meridianTcm" value="Yang Ming LI" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Yang Ming LI</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="meridianTcm" value="Yang Ming ST" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Yang Ming ST</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="meridianTcm" value="Tai YIn SP" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Tai YIn SP</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="meridianTcm" value="Shao YIn HT" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Shao YIn HT</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="meridianTcm" value="Tai Yang Si" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Tai Yang Si</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="meridianTcm" value="Taiyang UB" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Taiyang UB</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="meridianTcm" value="Shao Yin KI" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Shao Yin KI</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="meridianTcm" value="Jue Yin PC" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Jue Yin PC</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="meridianTcm" value="Shao Yang SJ" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Shao Yang SJ</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="meridianTcm" value="Shao Yang GB" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Shao Yang GB</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="meridianTcm" value="Jue Yin LR" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Jue Yin LR</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="meridianTcm" value="Dumai" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Dumai</span>
                        </label>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="bianBing" class="block text-sm font-medium text-gray-700">Bian Bing (Disorders)</label>
                        <textarea id="bianBing" name="bianBing" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
                    </div>
                    <div>
                        <label for="bianZheng" class="block text-sm font-medium text-gray-700">Bian Zheng (Syndrome Diagnosis)</label>
                        <textarea id="bianZheng" name="bianZheng" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
                    </div>
                </div>
                <div class="space-y-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Perawatan</label>
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3">
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="perawatan" value="Akupunktur" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Akupunktur</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="perawatan" value="Herbal" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Herbal</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="perawatan" value="Elektro Akupunktur" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Elektro Akupunktur</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="perawatan" value="Bekam Api" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Bekam Api</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="perawatan" value="Bekam Basah" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Bekam Basah</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="perawatan" value="Moksa" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Moksa</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="perawatan" value="TDP" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">TDP</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="perawatan" value="Infra Red" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Infra Red</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="perawatan" value="Tuina" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Tuina</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="perawatan" value="Guasha" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Guasha</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="perawatan" value="Dietetik" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Dietetik</span>
                        </label>
                        <label class="flex items-center space-x-2">
                            <input type="checkbox" name="perawatan" id="perawatanLainnya" value="Lain-lain" class="form-checkbox rounded text-indigo-600 h-4 w-4">
                            <span class="text-sm text-gray-700">Lain-lain</span>
                        </label>
                    </div>
                    <input type="text" id="perawatanLainnyaInput" name="perawatanLainnyaInput" placeholder="Masukkan perawatan lainnya..." class="mt-2 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm hidden">
                </div>
                <div>
                    <label for="pemeriksaanPenunjangLain" class="block text-sm font-medium text-gray-700">Pemeriksaan Penunjang Lain</label>
                    <textarea id="pemeriksaanPenunjangLain" name="pemeriksaanPenunjangLain" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
                </div>
                <div>
                    <label for="notes" class="block text-sm font-medium text-gray-700">Catatan/Diagnosa</label>
                    <textarea id="notes" name="notes" rows="3" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
                </div>
                <div>
                    <label for="treatment" class="block text-sm font-medium text-gray-700">Perawatan (Akupunktur & Herbal)</label>
                    <textarea id="treatment" name="treatment" rows="3" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"></textarea>
                </div>
                <div class="flex justify-between items-center space-x-3">
                    <button id="print-form-btn" type="button" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">Cetak</button>
                    <button id="submit-form-btn" type="submit" class="w-full px-6 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        Tambahkan Pasien
                    </button>
                    <button id="update-form-btn" type="submit" class="w-full px-6 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 hidden">
                        Simpan Perubahan
                    </button>
                </div>
            </form>
        </div>
    </div>


    <!-- Firebase & Aplikasi JS -->
    <script type="module">
        // Impor modul Firebase yang diperlukan
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection, query, addDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getDocs, limit, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Tampilkan debug log Firestore
        setLogLevel('debug');
        
        // Elemen-elemen DOM
        const loginView = document.getElementById('login-view');
        const patientListView = document.getElementById('patient-list-view');
        const formView = document.getElementById('form-view');
        const formTitle = document.getElementById('form-title');
        const patientForm = document.getElementById('patient-form');
        const loginForm = document.getElementById('login-form');
        const patientList = document.getElementById('patient-list');
        const noPatientsMsg = document.getElementById('no-patients');
        const loadingSpinner = document.getElementById('loading');
        const userIdDisplay = document.getElementById('user-id');
        const addNewPatientBtn = document.getElementById('add-new-patient-btn');
        const backBtn = document.getElementById('back-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const submitFormBtn = document.getElementById('submit-form-btn');
        const updateFormBtn = document.getElementById('update-form-btn');
        const printFormBtn = document.getElementById('print-form-btn');
        const tanggalLahirInput = document.getElementById('tanggalLahir');
        const umurInput = document.getElementById('umur');
        const pekerjaanSelect = document.getElementById('pekerjaan');
        const pekerjaanLainnyaInput = document.getElementById('pekerjaanLainnyaInput');
        const bianBingInput = document.getElementById('bianBing');
        const bianZhengInput = document.getElementById('bianZheng');
        const notesInput = document.getElementById('notes');
        const treatmentTextarea = document.getElementById('treatment');
        const perawatanLainnyaInput = document.getElementById('perawatanLainnyaInput');
        const perawatanLainnyaCheckbox = document.getElementById('perawatanLainnya');
        const agamaSelect = document.getElementById('agama');
        const agamaLainnyaInput = document.getElementById('agamaLainnyaInput');
        
        // Elemen-elemen baru untuk dropdown
        const tcmLidahSelect = document.getElementById('tcmLidahSelect');
        const lidahDescriptionDiv = document.getElementById('lidah-description');
        const tcmLidahLainnyaInput = document.getElementById('tcmLidahLainnyaInput');
        const tcmSelaputLidahSelect = document.getElementById('tcmSelaputLidahSelect');
        const tcmSelaputLidahLainnyaInput = document.getElementById('tcmSelaputLidahLainnyaInput');
        const tcmNadiLainnya = document.getElementById('tcmNadiLainnya');
        const tcmNadiLainnyaInput = document.getElementById('tcmNadiLainnyaInput');
        const loginErrorMessage = document.getElementById('login-error-message');

        // Elemen message box
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');

        // Variabel global Firebase
        let app, db, auth;
        let userId = null;
        let isAuthReady = false;
        let editingDocId = null;

        // Hardcoded kredensial untuk login sederhana
        const USERNAME = 'admin';
        const PASSWORD = 'password123';
        
        // Data Nadi dan deskripsinya
        const nadiDescriptions = {
            "Nadi Fu/Mengambang (浮脈)": `"Sewaktu diangkat terasa jelas, sewaktu ditekan tidak terlalu terasa." Nadi ini menjelaskan penyakit ada di Biao/permukaan, juga menjelaskan sindrom Xu/defisiensi. Nadi ini juga ditemui pada pasien oedema (cairan didalam kulit).`,
            "Nadi Chen/Dalam (沉脈)": `"Sewaktu diangkat tidak terasa, sewaktu ditekan bertenaga." Nadi ini menjelaskan penyakit ada di Li/dalam, juga bisa ada pada orang normal yang tidak ada penyakit apapun.`,
            "Nadi Chi/Terlambat (迟脈)": `"Satu hitungan, 3x datang." Nadi ini bisa terjadi pada gejala Han/dingin, dan Re/panas, juga bisa ada pada olahragawan/atlet.`,
            "Nadi Shuo/Cepat (数脈)": `"Satu hitungan, 6x datang." Nadi ini menjelaskan gejala Re/panas, Yin Xu/Defisiensi Yin, Qi Xu/Defisiensi Qi, Xue Xu/Defisiensi Xue, gejala Han/dingin juga ditemui pada nadi Shuo. Nadi ini juga sering ada pada bayi berusia sebulan, orang yang melakukan aktivitas berat, minum alcohol, baru saja makan, maupun rangsangan emosi berlebihan.`,
            "Nadi Hong/Besar (洪脈)": `"Sewaktu ditekan mengambang dan besar, dibawah jari terasa penuh." Nadi ini menjelaskan panas didalam tubuh/organ tubuh, ada pada gejala demam tinggi, infeksi, etc. Bisa juga terjadi pada Qi Xu/Defisiensi Qi, kehilangan darah, terlalu lelah, mencret berkepanjangan, etc.`,
            "Nadi Wei/Kecil (微脈)": `"Amat kecil, lunak, hampir tidak terasa, seperti ada dan tidak." Nadi ini menjelaskan defisiensi Qi dan Xue. Pada sakit berkepanjangan/kronis, nadi ini menjelaskan prognosis jelek. Pada sakit akut, nadi ini menjelaskan prognosis baik.`,
            "Nadi Xi/Halus (细脈)": `"Halus seperti benang, tapi terasa di jari." Nadi ini menjelaskan defisiensi Qi dan Xue, faktor patogen lembab.`,
            "Nadi San/Lepas (散脈)": `"Mengambang lepas dan tidak ada dasarnya, tidak beraturan." Nadi ini menjelaskan Yuan Qi lepas dan hilang.`,
            "Nadi Xu/Lemah (虚脈)": `"3 jari diangkat tidak bertenaga, ditekan kosong." Nadi ini menjelaskan gejala Xu/defisiensi.`,
            "Nadi Shi/Penuh (实脈)": `"3 jari diangkat dan ditekan terasa bertenaga." Nadi ini menjelaskan gejala Shi/ekses, gejala panas, faktor patogen yang berlebihan. Nadi ini juga dijumpai pada orang normal.`,
            "Nadi Hua/Licin (滑脈)": `"Lancar tanpa putus, seperti mutiara diatas nampan, terasa dijari licin dan bundar." Nadi ini menjelaskan gejala Tan/dahak, gejala Yin/cairan tubuh, makanan yang tidak tercerna, panas ekses ditubuh, darah stasis. Pada orang normal, nadi ini juga sering dijumpai. Wanita hamil, sering dijumpai nadi Hua/licin dan Shuo/cepat.`,
            "Nadi Se/Seret (涩脈)": `"Lambat, halus dan pendek, seret, tidak lancar." Nadi ini bisa berarti Xu/defisiensi, bisa berarti Shi/ekses. Bila Shi/ekses, maka pasti terasa penuh bertenaga. Misalnya pada gejala Tan/dahak, makanan tidak tercerna, Qi macet dan darah stasis.`,
            "Nadi Chang/Panjang (长脈)": `"Kepala dan ekor terasa panjang, melewati 1 ruas jari." Nadi ini biasanya ada pada ekses Yang Liver. Bila ditemui nadi Chang/Panjang dan nadi Huan/Lambat, ini termasuk nadi normal.`,
            "Nadi Duan/Pendek (短脈)": `"Kepala dan ekor terasa pendek, tidak sampai 1 ruas jari." Nadi ini biasanya ada pada gejala Qi, baik Defisiensi maupun ekses.`,
            "Nadi Xian/Senar (弦脈)": `"Tegang dan lurus seperti memegang senar kecapi." Nadi ini menjelaskan gejala Liver dan empedu, Tan/dahak, cairan tubuh yang berhenti, sakit dibagian tubuh, malaria, juga gejala Xu/defisiensi.`,
            "Nadi Kou/Kosong (芤脈)": `"Mengambang dan besar tapi terasa kosong, seperti menekan batang daun bawang." Nadi ini menjelaskan gejala kehilangan darah, Yin tubuh luka atau defisiensi Yin.`,
            "Nadi Jin/Rapat (紧脈)": `"Nadi datang beriringan, saling menyambung tanpa putus." Nadi ini menjelaskan gejala Han/dingin, sakit di bagian tubuh, makanan yang tidak tercerna.`,
            "Nadi Huan/Lambat (缓脈)": `"Satu hitungan 4x datang, datang dan pergi terasa pelan." Nadi ini menjelaskan gejala Lembab, pencernaan lemah, angin dan gejala panas di dalam tubuh.`,
            "Nadi Ge/革脈": `"Mengambang terasa di jari, di dalam kosong, diluar keras, seperti menekan tambur." Nadi ini menjelaskan kehilangan darah, kehilangan Jing Ginjal, pendarahan, kebanyakan karena defisiensi Qi yang mengakibatkan defisiensi Ying Xue.`,
            "Nadi Lao/Keras (牢脈)": `"Ditekan dalam terasa penuh, panjang dan seperti senar, tidak mudah digerakkan." Nadi ini menjelaskan Yin Han yang membeku didalam, atherosclerosis. Mis: Radang ginjal kronis.`,
            "Nadi Ruo/Rapuh (弱脈)": `"Terasa sangat lunak, tipis dan dalam." Nadi ini menjelaskan Defisiensi Qi dan Xue, Yuan Qi luka. Kalau dijumpai pada orang tua, sakit berkepanjangan, tms normal.`,
            "Nadi Ru/濡脈": `"Mengambang dan terasa halus, lunak." Nadi ini menjelaskan gejala defisiensi, lembab di dalam tubuh.`,
            "Nadi Fu/伏脈": `"Ditekan kuat, mencari dengan jarii baru terasa, kadang hilang tidak terasa." Nadi ini menjelaskan Xie Qi (faktor patogen luar) yang menutup, sakit hebat didalam tubuh, defisiensi Yang didalam tubuh.`,
            "Nadi Dong/Bergerak (动脉)": `"Bentuknya seperti kacang, mudah digerakkan, terasa licin, cepat, bertenaga." Nadi ini menjelaskan gejala sakit, kaget. Sering juga dijumpai dalam kehamilan 1-2 bulan.`,
            "Nadi Cu/促脈": `"Datang cepat, kadang terhenti, polanya tidak beraturan." Nadi ini menjelaskan ekses Yang dan panas tinggi, Qi Xue Tan Yin yang macet. Nadi ini juga menjelaskan defisiensi Yang Utama dalam tubuh.`,
            "Nadi Jie/结脈": `"Datang pelan, kadang terhenti, polanya tidak beraturan." Nadi ini menjelaskan ekses Yin, Qi macet, darah stasis, Dahak dingin, makanan beku, makanan tidak tercerna, faktor patogen Han dalam Jing Luo. Nadi ini juga menjelaskan defisiensi Qi Utama dalam tubuh.`,
            "Nadi Dai/代脈": `"Nadi datang kadang terhenti, polanya teratur, setelah berapa lama terulang lagi." Nadi ini menjelaskan defisiensi Qi, faktor patogen luar angin, penyakit tipes, emosi berlebihan, darah beku karena terjatuh.`,
            "Nadi Ji/疾脈": `"Nadi datang cepat terburu-buru, satu hitungan 7-8x datang." Nadi ini menjelaskan Yin dan Yang utama dalam tubuh akan hilang. Sering dijumpai pada penyakit tipes, dan panas tinggi.`,
        };

        // Data Lidah dan deskripsinya
        const lidahDescriptions = {
            "Pucat": `Mengindikasikan kondisi Dingin atau Defisiensi Darah (Xue Xu).`,
            "Merah": `Mengindikasikan Panas dalam tubuh.`,
            "Ungu": `Mengindikasikan Stasis Darah (Xue Yu) atau Panas ekstrem.`,
            "Tebal": `Mengindikasikan kondisi Patogen, seperti Lembab atau Dahak.`,
            "Tipis": `Mengindikasikan Defisiensi atau kondisi Normal.`,
            "Retak": `Menunjukkan Yin Xu/Defisiensi Yin.`,
            "Bengkak": `Mengindikasikan Defisiensi Qi dan Patogen Lembab.`,
            "Bintik": `Menunjukkan Stasis Darah (Xue Yu).`,
            "Lain-lain": `Catatan tambahan mengenai kondisi lidah yang tidak termasuk dalam pilihan.`,
        };
        
        // Data Perawatan
        const treatments = [
            "Akupunktur", "Herbal", "Elektro Akupunktur", "Bekam Api", "Bekam Basah", "Moksa", "TDP", "Infra Red", "Tuina", "Guasha", "Dietetik", "Lain-lain"
        ];
        
        // Data Kategori Kunjungan
        const kunjunganKategoriOptions = [
            "Nyeri", "Internal", "Eksternal", "Promil", "Ginekologi", "Rehabilitasi Stroke", "Psiko Somatik", "Pemeliharaan Kesehatan", "Promil Online", "Pendampingan IVF"
        ];

        // Tampilkan pesan sementara
        function showMessage(message, duration = 3000) {
            messageText.textContent = message;
            messageBox.classList.remove('translate-x-full');
            setTimeout(() => {
                messageBox.classList.add('translate-x-full');
            }, duration);
        }

        // Tampilkan loading spinner
        function showLoading() {
            loadingSpinner.classList.remove('hidden');
        }

        // Sembunyikan loading spinner
        function hideLoading() {
            loadingSpinner.classList.add('hidden');
        }

        // Alihkan ke tampilan login
        function switchToLoginView() {
            patientListView.classList.add('hidden');
            formView.classList.add('hidden');
            loginView.classList.remove('hidden');
            patientForm.reset();
            loginForm.reset();
        }

        // Alihkan ke tampilan daftar pasien
        function switchToPatientListView() {
            loginView.classList.add('hidden');
            formView.classList.add('hidden');
            patientListView.classList.remove('hidden');
        }

        // Alihkan ke tampilan formulir
        function switchToFormView() {
            patientListView.classList.add('hidden');
            formView.classList.remove('hidden');
        }

        // Inisialisasi Firebase
        function initializeFirebase() {
            try {
                // Gunakan variabel global yang disediakan oleh lingkungan Canvas
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                // Pastikan konfigurasi valid sebelum inisialisasi
                if (!firebaseConfig.apiKey) {
                    console.error("Firebase config is missing API key.");
                    return;
                }

                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Set persistensi sesi browser
                setPersistence(auth, browserSessionPersistence).then(() => {
                    // Cek status autentikasi
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            userId = user.uid;
                            userIdDisplay.textContent = userId;
                            isAuthReady = true;
                            // Panggil fungsi utama setelah otentikasi siap
                            listenForPatients();
                        } else if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            // Masuk secara anonim jika tidak ada token
                            await signInAnonymously(auth);
                        }
                    });
                }).catch((error) => {
                    console.error("Error setting persistence: ", error);
                });
            } catch (error) {
                console.error("Failed to initialize Firebase:", error);
                showMessage("Gagal menginisialisasi Firebase. Cek konfigurasi.");
                hideLoading();
            }
        }
        
        // Fungsi untuk menghitung umur
        function calculateAge(dob) {
            if (!dob) return '';
            const today = new Date();
            const birthDate = new Date(dob);
            let age = today.getFullYear() - birthDate.getFullYear();
            const m = today.getMonth() - birthDate.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            return `${age} tahun`;
        }
        
        // Event listener untuk tanggal lahir
        tanggalLahirInput.addEventListener('change', (e) => {
            const dob = e.target.value;
            umurInput.value = calculateAge(dob);
        });
        
        // Event listener untuk pilihan pekerjaan
        pekerjaanSelect.addEventListener('change', () => {
            if (pekerjaanSelect.value === 'Lain-lain') {
                pekerjaanLainnyaInput.classList.remove('hidden');
            } else {
                pekerjaanLainnyaInput.classList.add('hidden');
                pekerjaanLainnyaInput.value = '';
            }
        });
        
        // Listener untuk opsi "Lain-lain" pada dropdown Agama
        agamaSelect.addEventListener('change', () => {
            if (agamaSelect.value === 'Lain-lain') {
                agamaLainnyaInput.classList.remove('hidden');
            } else {
                agamaLainnyaInput.classList.add('hidden');
                agamaLainnyaInput.value = '';
            }
        });

        // Listener untuk opsi "Lain-lain" pada checkbox Perawatan
        perawatanLainnyaCheckbox.addEventListener('change', (e) => {
            if (e.target.checked) {
                perawatanLainnyaInput.classList.remove('hidden');
            } else {
                perawatanLainnyaInput.classList.add('hidden');
                perawatanLainnyaInput.value = '';
            }
        });

        // Mendengarkan perubahan data pasien secara real-time
        function listenForPatients() {
            if (!isAuthReady || !db) return;
            const collectionPath = `/artifacts/${typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'}/public/data/patient-records`;
            const patientsCollection = collection(db, collectionPath);
            
            showLoading();

            const q = query(patientsCollection);
            onSnapshot(q, (snapshot) => {
                const patients = [];
                snapshot.forEach(doc => {
                    patients.push({ id: doc.id, ...doc.data() });
                });
                renderPatients(patients);
                hideLoading();
            }, (error) => {
                console.error("Error listening to patient data: ", error);
                showMessage("Gagal memuat data pasien.");
                hideLoading();
            });
        }

        // Merender daftar pasien ke UI
        function renderPatients(patients) {
            patientList.innerHTML = '';
            if (patients.length === 0) {
                noPatientsMsg.classList.remove('hidden');
            } else {
                noPatientsMsg.classList.add('hidden');
                // Sort by creation date
                patients.sort((a, b) => (a.createdAt && b.createdAt) ? b.createdAt.toDate() - a.createdAt.toDate() : 0);

                patients.forEach(patient => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-100 transition-colors';
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${patient.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${patient.patientId}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${patient.tanggal || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                            <button onclick="viewPatient('${patient.id}')" class="px-3 py-1 text-xs font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">Lihat/Edit</button>
                            <button onclick="deletePatient('${patient.id}')" class="px-3 py-1 text-xs font-medium text-white bg-red-600 rounded-md hover:bg-red-700">Hapus</button>
                            <button onclick="nextVisit('${patient.id}')" class="px-3 py-1 text-xs font-medium text-white bg-purple-600 rounded-md hover:bg-purple-700">Kunjungan Berikutnya</button>
                        </td>
                    `;
                    patientList.appendChild(row);
                });
            }
        }
        
        // Fungsi untuk menghasilkan ID pasien berikutnya
        async function generateNextPatientId() {
            const collectionPath = `/artifacts/${typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'}/public/data/patient-records`;
            const patientsCollection = collection(db, collectionPath);
            const q = query(patientsCollection, orderBy('patientId', 'desc'), limit(1));
            
            try {
                const querySnapshot = await getDocs(q);
                let nextIdNumber = 1;

                if (!querySnapshot.empty) {
                    const lastPatient = querySnapshot.docs[0].data();
                    const lastId = lastPatient.patientId;
                    const lastIdNumber = parseInt(lastId.substring(2));
                    nextIdNumber = lastIdNumber + 1;
                }

                return 'SF' + nextIdNumber.toString().padStart(6, '0');
            } catch (error) {
                console.error("Error generating new patient ID:", error);
                showMessage("Gagal membuat ID pasien otomatis.");
                return null;
            }
        }

        // Tampilkan formulir untuk pasien baru
        addNewPatientBtn.addEventListener('click', async () => {
            patientForm.reset();
            formTitle.textContent = 'Tambah Pasien Baru';
            editingDocId = null;
            submitFormBtn.classList.remove('hidden');
            updateFormBtn.classList.add('hidden');

            const newId = await generateNextPatientId();
            patientForm.patientId.value = newId;
            patientForm.patientId.readOnly = true;
            
            // Reset nadi checkboxes and input
            document.querySelectorAll('input[name="pemeriksaanNadi"]').forEach(cb => cb.checked = false);
            tcmNadiLainnyaInput.classList.add('hidden');
            tcmNadiLainnyaInput.value = '';

            // Reset lidah dropdowns
            document.querySelectorAll('input[name="pemeriksaanLidah"]').forEach(cb => cb.checked = false);
            tcmLidahLainnyaInput.classList.add('hidden');
            tcmLidahLainnyaInput.value = '';
            document.querySelectorAll('input[name="pemeriksaanSelaputLidah"]').forEach(cb => cb.checked = false);
            tcmSelaputLidahLainnyaInput.classList.add('hidden');
            tcmSelaputLidahLainnyaInput.value = '';

            // Reset meridian checkboxes
            document.querySelectorAll('input[name="meridianTcm"]').forEach(cb => cb.checked = false);
            
            // Reset kategori kunjungan
            document.querySelectorAll('input[name="kunjunganKategori"]').forEach(cb => cb.checked = false);

            // Reset treatment multiselect
            document.querySelectorAll('input[name="perawatan"]').forEach(cb => cb.checked = false);
            perawatanLainnyaInput.classList.add('hidden');
            perawatanLainnyaInput.value = '';

            patientForm.nyeri.value = '';
            bianBingInput.value = '';
            bianZhengInput.value = '';
            notesInput.value = '';
            treatmentTextarea.value = '';
            umurInput.value = '';
            pekerjaanSelect.value = '';
            pekerjaanLainnyaInput.classList.add('hidden');
            pekerjaanLainnyaInput.value = '';
            agamaSelect.value = '';
            agamaLainnyaInput.classList.add('hidden');
            agamaLainnyaInput.value = '';
            
            switchToFormView();
        });

        // Handler tombol Kembali
        backBtn.addEventListener('click', () => {
            switchToPatientListView();
        });

        // Tampilkan formulir dengan data pasien untuk diedit
        window.viewPatient = async (docId) => {
            showLoading();
            const collectionPath = `/artifacts/${typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'}/public/data/patient-records`;
            const patientDocRef = doc(db, collectionPath, docId);

            try {
                const docSnap = await getDoc(patientDocRef);
                if (docSnap.exists) {
                    const data = docSnap.data();
                    patientForm.name.value = data.name;
                    patientForm.patientId.value = data.patientId;
                    patientForm.tanggalLahir.value = data.tanggalLahir || '';
                    umurInput.value = calculateAge(data.tanggalLahir);
                    patientForm.jenisKelamin.value = data.jenisKelamin || '';
                    
                    // Set agama
                    const agamaOpt = Array.from(agamaSelect.options).find(opt => opt.value === data.agama);
                    if (agamaOpt) {
                        agamaSelect.value = data.agama;
                        agamaLainnyaInput.classList.add('hidden');
                    } else if (data.agama) {
                        agamaSelect.value = 'Lain-lain';
                        agamaLainnyaInput.classList.remove('hidden');
                        agamaLainnyaInput.value = data.agama;
                    } else {
                        agamaSelect.value = '';
                        agamaLainnyaInput.classList.add('hidden');
                    }
                    
                    // Set pekerjaan
                    const pekerjaanOpt = Array.from(pekerjaanSelect.options).find(opt => opt.value === data.pekerjaan);
                    if (pekerjaanOpt) {
                        pekerjaanSelect.value = data.pekerjaan;
                        pekerjaanLainnyaInput.classList.add('hidden');
                    } else if (data.pekerjaan) {
                        pekerjaanSelect.value = 'Lain-lain';
                        pekerjaanLainnyaInput.classList.remove('hidden');
                        pekerjaanLainnyaInput.value = data.pekerjaan;
                    } else {
                        pekerjaanSelect.value = '';
                        pekerjaanLainnyaInput.classList.add('hidden');
                    }

                    patientForm.tanggal.value = data.tanggal || '';
                    patientForm.alamat.value = data.alamat || '';
                    patientForm.nik.value = data.nik || '';
                    patientForm.noHp.value = data.noHp || '';
                    patientForm.keluhanUtama.value = data.keluhanUtama || '';
                    patientForm.keluhanTambahan.value = data.keluhanTambahan || '';
                    patientForm.anamnesa.value = data.anamnesa || '';
                    patientForm.pemeriksaanFisik.value = data.pemeriksaanFisik || '';
                    patientForm.nyeri.value = data.nyeri || '';
                    
                    // Isi checkbox Nadi
                    document.querySelectorAll('input[name="pemeriksaanNadi"]').forEach(cb => {
                        cb.checked = false;
                        if (data.pemeriksaanNadi && data.pemeriksaanNadi.includes(cb.value)) {
                            cb.checked = true;
                        }
                    });
                    if (data.pemeriksaanNadi && data.pemeriksaanNadi.includes('Lain-lain') && data.pemeriksaanNadi.length > 1) {
                         tcmNadiLainnyaInput.classList.remove('hidden');
                         tcmNadiLainnyaInput.value = data.pemeriksaanNadi.filter(v => v !== 'Lain-lain').join(', ');
                    } else {
                         tcmNadiLainnyaInput.classList.add('hidden');
                         tcmNadiLainnyaInput.value = '';
                    }

                    // Isi checkbox Lidah
                    document.querySelectorAll('input[name="pemeriksaanLidah"]').forEach(cb => {
                        cb.checked = false;
                        if (data.pemeriksaanLidah && data.pemeriksaanLidah.includes(cb.value)) {
                            cb.checked = true;
                        }
                    });
                    if (data.pemeriksaanLidah && data.pemeriksaanLidah.includes('Lain-lain') && data.pemeriksaanLidah.length > 1) {
                         tcmLidahLainnyaInput.classList.remove('hidden');
                         tcmLidahLainnyaInput.value = data.pemeriksaanLidah.filter(v => v !== 'Lain-lain').join(', ');
                    } else {
                         tcmLidahLainnyaInput.classList.add('hidden');
                         tcmLidahLainnyaInput.value = '';
                    }
                    
                    // Isi checkbox Selaput Lidah
                    document.querySelectorAll('input[name="pemeriksaanSelaputLidah"]').forEach(cb => {
                        cb.checked = false;
                        if (data.pemeriksaanSelaputLidah && data.pemeriksaanSelaputLidah.includes(cb.value)) {
                            cb.checked = true;
                        }
                    });
                    if (data.pemeriksaanSelaputLidah && data.pemeriksaanSelaputLidah.includes('Lain-lain') && data.pemeriksaanSelaputLidah.length > 1) {
                        tcmSelaputLidahLainnyaInput.classList.remove('hidden');
                        tcmSelaputLidahLainnyaInput.value = data.pemeriksaanSelaputLidah.filter(v => v !== 'Lain-lain').join(', ');
                    } else {
                        tcmSelaputLidahLainnyaInput.classList.add('hidden');
                        tcmSelaputLidahLainnyaInput.value = '';
                    }
                    
                    // Isi meridian checkboxes
                    document.querySelectorAll('input[name="meridianTcm"]').forEach(cb => {
                        cb.checked = false;
                        if (data.pemeriksaanMeridian && data.pemeriksaanMeridian.includes(cb.value)) {
                            cb.checked = true;
                        }
                    });
                    
                    // Isi kategori kunjungan
                    document.querySelectorAll('input[name="kunjunganKategori"]').forEach(cb => {
                        cb.checked = false;
                        if (data.kategoriKunjungan && data.kategoriKunjungan.includes(cb.value)) {
                            cb.checked = true;
                        }
                    });

                    // Isi form diagnosa dan perawatan
                    bianBingInput.value = data.bianBing || '';
                    bianZhengInput.value = data.bianZheng || '';
                    notesInput.value = data.notes || '';
                    treatmentTextarea.value = data.treatment || '';

                    // Isi treatment multiselect
                    document.querySelectorAll('input[name="perawatan"]').forEach(cb => {
                        cb.checked = false;
                        if (data.perawatan && data.perawatan.includes(cb.value)) {
                            cb.checked = true;
                        }
                    });
                    if (data.perawatan && data.perawatan.includes('Lain-lain') && data.perawatan.length > 1) {
                        perawatanLainnyaInput.classList.remove('hidden');
                        perawatanLainnyaInput.value = data.perawatan.filter(v => v !== 'Lain-lain').join(', ');
                    } else {
                        perawatanLainnyaInput.classList.add('hidden');
                        perawatanLainnyaInput.value = '';
                    }
                    
                    formTitle.textContent = 'Edit Rekam Medik';
                    editingDocId = docId;
                    submitFormBtn.classList.add('hidden');
                    updateFormBtn.classList.remove('hidden');
                    patientForm.patientId.readOnly = true;

                    switchToFormView();
                } else {
                    showMessage("Dokumen tidak ditemukan.");
                }
            } catch (error) {
                console.error("Error fetching patient details:", error);
                showMessage("Gagal memuat detail pasien.");
            } finally {
                hideLoading();
            }
        };

        // Fungsi untuk Kunjungan Berikutnya
        window.nextVisit = async (docId) => {
            showLoading();
            const collectionPath = `/artifacts/${typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'}/public/data/patient-records`;
            const patientDocRef = doc(db, collectionPath, docId);

            try {
                const docSnap = await getDoc(patientDocRef);
                if (docSnap.exists) {
                    const data = docSnap.data();
                    
                    // Isi formulir dengan data pasien yang dipilih
                    patientForm.reset();
                    patientForm.name.value = data.name || '';
                    const newId = await generateNextPatientId();
                    patientForm.patientId.value = newId;
                    patientForm.tanggalLahir.value = data.tanggalLahir || '';
                    umurInput.value = calculateAge(data.tanggalLahir);
                    patientForm.jenisKelamin.value = data.jenisKelamin || '';
                    agamaSelect.value = data.agama || '';
                    pekerjaanSelect.value = data.pekerjaan || '';
                    if (pekerjaanSelect.value === 'Lain-lain') {
                        pekerjaanLainnyaInput.classList.remove('hidden');
                        pekerjaanLainnyaInput.value = data.pekerjaan || '';
                    } else {
                        pekerjaanLainnyaInput.classList.add('hidden');
                        pekerjaanLainnyaInput.value = '';
                    }
                    patientForm.alamat.value = data.alamat || '';
                    patientForm.nik.value = data.nik || '';
                    patientForm.noHp.value = data.noHp || '';

                    // Kosongkan bidang untuk kunjungan baru
                    patientForm.tanggal.value = '';
                    patientForm.keluhanUtama.value = '';
                    patientForm.keluhanTambahan.value = '';
                    patientForm.anamnesa.value = '';
                    patientForm.pemeriksaanFisik.value = '';
                    patientForm.nyeri.value = '';
                    patientForm.pemeriksaanPenunjangLain.value = '';
                    notesInput.value = '';
                    treatmentTextarea.value = '';
                    bianBingInput.value = '';
                    bianZhengInput.value = '';
                    
                    // Reset Nadi checkboxes
                    document.querySelectorAll('input[name="pemeriksaanNadi"]').forEach(cb => cb.checked = false);
                    tcmNadiLainnyaInput.classList.add('hidden');
                    tcmNadiLainnyaInput.value = '';
                    
                    // Reset Lidah checkboxes
                    document.querySelectorAll('input[name="pemeriksaanLidah"]').forEach(cb => cb.checked = false);
                    tcmLidahLainnyaInput.classList.add('hidden');
                    tcmLidahLainnyaInput.value = '';
                    
                    // Reset Selaput Lidah checkboxes
                    document.querySelectorAll('input[name="pemeriksaanSelaputLidah"]').forEach(cb => cb.checked = false);
                    tcmSelaputLidahLainnyaInput.classList.add('hidden');
                    tcmSelaputLidahLainnyaInput.value = '';

                    // Reset Meridian checkboxes
                    document.querySelectorAll('input[name="meridianTcm"]').forEach(cb => cb.checked = false);

                    // Reset Kategori Kunjungan
                    document.querySelectorAll('input[name="kunjunganKategori"]').forEach(cb => cb.checked = false);
                    
                    // Reset treatment multiselect
                    document.querySelectorAll('input[name="perawatan"]').forEach(cb => cb.checked = false);
                    perawatanLainnyaInput.classList.add('hidden');
                    perawatanLainnyaInput.value = '';
                    agamaLainnyaInput.classList.add('hidden');
                    agamaLainnyaInput.value = '';

                    formTitle.textContent = 'Tambah Kunjungan Berikutnya';
                    editingDocId = null;
                    submitFormBtn.classList.remove('hidden');
                    updateFormBtn.classList.add('hidden');
                    patientForm.patientId.readOnly = false;
                    
                    switchToFormView();
                    showMessage(`Data untuk ${data.name} berhasil dimuat untuk kunjungan berikutnya.`);
                } else {
                    showMessage("Dokumen pasien tidak ditemukan.");
                }
            } catch (error) {
                console.error("Error preparing for next visit:", error);
                showMessage("Gagal memuat data untuk kunjungan berikutnya.");
            } finally {
                hideLoading();
            }
        };
        
        // Menangani pengiriman formulir
        patientForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            let pekerjaan = pekerjaanSelect.value;
            if (pekerjaan === 'Lain-lain') {
                pekerjaan = pekerjaanLainnyaInput.value.trim();
            }
            
            let agama = agamaSelect.value;
            if (agama === 'Lain-lain') {
                agama = agamaLainnyaInput.value.trim();
            }

            const selectedNadi = Array.from(document.querySelectorAll('input[name="pemeriksaanNadi"]:checked')).map(cb => cb.value);
            if (selectedNadi.includes('Lain-lain') && tcmNadiLainnyaInput.value.trim()) {
                selectedNadi.push(tcmNadiLainnyaInput.value.trim());
            }

            const selectedLidah = Array.from(document.querySelectorAll('input[name="pemeriksaanLidah"]:checked')).map(cb => cb.value);
            if (selectedLidah.includes('Lain-lain') && tcmLidahLainnyaInput.value.trim()) {
                selectedLidah.push(tcmLidahLainnyaInput.value.trim());
            }

            const selectedSelaputLidah = Array.from(document.querySelectorAll('input[name="pemeriksaanSelaputLidah"]:checked')).map(cb => cb.value);
            if (selectedSelaputLidah.includes('Lain-lain') && tcmSelaputLidahLainnyaInput.value.trim()) {
                selectedSelaputLidah.push(tcmSelaputLidahLainnyaInput.value.trim());
            }

            const selectedMeridian = Array.from(document.querySelectorAll('input[name="meridianTcm"]:checked')).map(cb => cb.value);
            
            const selectedKunjunganKategori = Array.from(document.querySelectorAll('input[name="kunjunganKategori"]:checked')).map(cb => cb.value);
            
            const selectedPerawatan = Array.from(document.querySelectorAll('input[name="perawatan"]:checked')).map(cb => cb.value);
            if (selectedPerawatan.includes('Lain-lain') && perawatanLainnyaInput.value.trim()) {
                selectedPerawatan.push(perawatanLainnyaInput.value.trim());
            }

            const patientData = {
                name: patientForm.name.value.trim(),
                patientId: patientForm.patientId.value.trim(),
                jenisKelamin: patientForm.jenisKelamin.value,
                tanggalLahir: patientForm.tanggalLahir.value,
                umur: umurInput.value,
                agama: agama,
                pekerjaan: pekerjaan,
                tanggal: patientForm.tanggal.value,
                alamat: patientForm.alamat.value.trim(),
                nik: patientForm.nik.value.trim(),
                noHp: patientForm.noHp.value.trim(),
                kategoriKunjungan: selectedKunjunganKategori,
                keluhanUtama: patientForm.keluhanUtama.value.trim(),
                keluhanTambahan: patientForm.keluhanTambahan.value.trim(),
                anamnesa: patientForm.anamnesa.value.trim(),
                pemeriksaanFisik: patientForm.pemeriksaanFisik.value.trim(),
                nyeri: patientForm.nyeri.value.trim(),
                pemeriksaanNadi: selectedNadi,
                pemeriksaanLidah: selectedLidah,
                pemeriksaanSelaputLidah: selectedSelaputLidah,
                pemeriksaanMeridian: selectedMeridian,
                bianBing: bianBingInput.value.trim(),
                bianZheng: bianZhengInput.value.trim(),
                pemeriksaanPenunjangLain: patientForm.pemeriksaanPenunjangLain.value.trim(),
                perawatan: selectedPerawatan,
            };
            
            showLoading();

            const collectionPath = `/artifacts/${typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'}/public/data/patient-records`;

            try {
                if (editingDocId) {
                    // Update pasien
                    const patientDocRef = doc(db, collectionPath, editingDocId);
                    await setDoc(patientDocRef, { ...patientData, updatedAt: new Date() }, { merge: true });
                    showMessage("Perubahan berhasil disimpan.");
                } else {
                    // Tambah pasien baru
                    await addDoc(collection(db, collectionPath), { ...patientData, createdAt: new Date() });
                    showMessage("Pasien berhasil ditambahkan!");
                }
                
                patientForm.reset();
                switchToPatientListView();
            } catch (error) {
                console.error("Error saving patient:", error);
                showMessage("Gagal menyimpan data pasien.");
            } finally {
                hideLoading();
            }
        });

        // Hapus pasien
        window.deletePatient = async (docId) => {
            const confirmed = true; // Langsung hapus tanpa konfirmasi
            if (!confirmed) return;

            const collectionPath = `/artifacts/${typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'}/public/data/patient-records`;
            const patientDocRef = doc(db, collectionPath, docId);

            showLoading();
            try {
                await deleteDoc(patientDocRef);
                showMessage("Pasien berhasil dihapus.");
            } catch (error) {
                console.error("Error deleting patient:", error);
                showMessage("Gagal menghapus pasien.");
            } finally {
                hideLoading();
            }
        };
        
        // Handler untuk tombol cetak
        printFormBtn.addEventListener('click', () => {
            window.print();
        });

        // Listeners for Nadi and Lidah descriptions
        const nadiCheckboxes = document.querySelectorAll('input[name="pemeriksaanNadi"]');
        tcmNadiLainnya.addEventListener('change', (e) => {
            if (e.target.checked) {
                tcmNadiLainnyaInput.classList.remove('hidden');
                tcmNadiLainnyaInput.setAttribute('required', 'true');
            } else {
                tcmNadiLainnyaInput.classList.add('hidden');
                tcmNadiLainnyaInput.removeAttribute('required');
                tcmNadiLainnyaInput.value = '';
            }
        });
        
        const lidahCheckboxes = document.querySelectorAll('input[name="pemeriksaanLidah"]');
        const lidahLainnyaCheckbox = document.querySelector('input[name="pemeriksaanLidah"][value="Lain-lain"]');
        lidahLainnyaCheckbox.addEventListener('change', (e) => {
             if (e.target.checked) {
                 tcmLidahLainnyaInput.classList.remove('hidden');
                 tcmLidahLainnyaInput.setAttribute('required', 'true');
             } else {
                 tcmLidahLainnyaInput.classList.add('hidden');
                 tcmLidahLainnyaInput.removeAttribute('required');
                 tcmLidahLainnyaInput.value = '';
             }
         });
        
        const selaputLidahCheckboxes = document.querySelectorAll('input[name="pemeriksaanSelaputLidah"]');
        const selaputLidahLainnyaCheckbox = document.querySelector('input[name="pemeriksaanSelaputLidah"][value="Lain-lain"]');
        selaputLidahLainnyaCheckbox.addEventListener('change', (e) => {
            if (e.target.checked) {
                tcmSelaputLidahLainnyaInput.classList.remove('hidden');
                tcmSelaputLidahLainnyaInput.setAttribute('required', 'true');
            } else {
                tcmSelaputLidahLainnyaInput.classList.add('hidden');
                tcmSelaputLidahLainnyaInput.value = '';
            }
        });
        
        perawatanLainnyaCheckbox.addEventListener('change', (e) => {
            if (e.target.checked) {
                perawatanLainnyaInput.classList.remove('hidden');
            } else {
                perawatanLainnyaInput.classList.add('hidden');
                perawatanLainnyaInput.value = '';
            }
        });
        
        // Logic autentikasi
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = loginForm.username.value;
            const password = loginForm.password.value;
            
            if (username === USERNAME && password === PASSWORD) {
                loginErrorMessage.classList.add('hidden');
                switchToPatientListView();
                showMessage('Login berhasil!');
            } else {
                loginErrorMessage.textContent = 'Nama pengguna atau kata sandi salah.';
                loginErrorMessage.classList.remove('hidden');
            }
        });
        
        logoutBtn.addEventListener('click', () => {
            switchToLoginView();
            showMessage('Anda telah keluar.');
        });
        
        // Panggil fungsi inisialisasi saat window dimuat
        window.onload = initializeFirebase;
    </script>
</body>
</html>
